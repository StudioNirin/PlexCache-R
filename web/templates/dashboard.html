{% extends "base.html" %}

{% block content %}
<!-- Page Header -->
<header class="page-header">
    <div class="page-title">
        <div class="page-title-icon">
            <i data-lucide="layout-dashboard"></i>
        </div>
        <div>
            <h1>Dashboard</h1>
            <p>PlexCache-D Status Overview</p>
        </div>
    </div>
    <div class="action-buttons">
        <form id="run-form" style="display: inline-flex; align-items: center; gap: 0.75rem;"
              hx-post="/operations/run"
              hx-target="#global-operation-banner"
              hx-swap="innerHTML">
            <label class="switch" style="margin: 0;">
                <input type="checkbox" id="verbose-toggle" name="verbose" value="true">
                <span style="font-size: 0.85rem;">Verbose</span>
            </label>
            <input type="hidden" id="dry-run-input" name="dry_run" value="false">
            <button type="submit" class="btn btn-primary"
                    hx-indicator="#run-spinner"
                    {% if stats.is_running %}disabled{% endif %}>
                <span id="run-spinner" class="htmx-indicator spinner"></span>
                <i data-lucide="play" class="htmx-hide-on-request"></i>
                <span class="htmx-hide-on-request">Run Now</span>
            </button>
            <button type="button" class="btn btn-secondary"
                    onclick="document.getElementById('dry-run-input').value='true'; document.getElementById('run-form').requestSubmit(); document.getElementById('dry-run-input').value='false';"
                    {% if stats.is_running %}disabled{% endif %}>
                <i data-lucide="eye"></i>
                Dry Run
            </button>
        </form>
    </div>
</header>

<!-- Stats Row - lazy loaded -->
<div id="stats-container"
     hx-get="/api/dashboard/stats-content"
     hx-trigger="load"
     hx-swap="innerHTML">
    {% include "partials/dashboard_skeleton.html" %}
</div>

<!-- Recent Activity (Last 24 Hours) -->
<div class="card">
    <div class="card-header">
        <i data-lucide="activity"></i>
        <h2>Recent Activity</h2>
        <span class="text-muted" style="font-size: 0.75rem; margin-left: auto;">Last {{ retention_label }}</span>
    </div>
    <div class="activity-filter-bar" style="padding: 0.75rem 1.25rem;">
        <button class="activity-filter-pill active" data-filter="all">All</button>
        <button class="activity-filter-pill" data-filter="Cached">Cached</button>
        <button class="activity-filter-pill" data-filter="Restored">Restored</button>
        <button class="activity-filter-pill" data-filter="Moved to Array">Moved</button>
        <button class="activity-filter-pill" data-filter="other">Other</button>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="recent-activity-scroll">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Action</th>
                        <th>File</th>
                        <th>Users</th>
                        <th>Size</th>
                    </tr>
                </thead>
                <tbody id="recent-activity" hx-get="/operations/activity" hx-trigger="load, every 60s">
                    <tr>
                        <td colspan="5" class="text-muted" style="text-align: center; padding: 2rem;">
                            <span class="di-spinner" style="width: 20px; height: 20px; display: inline-block; margin-bottom: 0.5rem; border-top-color: var(--plex-text-muted); border-right-color: transparent;"></span>
                            <div style="font-size: 0.85rem;">Loading activity...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Persist verbose toggle preference
const VERBOSE_PREF_KEY = 'plexcache_dashboard_verbose';

function loadVerbosePreference() {
    const saved = localStorage.getItem(VERBOSE_PREF_KEY);
    if (saved === 'true') {
        document.getElementById('verbose-toggle').checked = true;
    }
}

function saveVerbosePreference() {
    const checked = document.getElementById('verbose-toggle').checked;
    localStorage.setItem(VERBOSE_PREF_KEY, checked ? 'true' : 'false');
}

// Load preference on page load
document.addEventListener('DOMContentLoaded', loadVerbosePreference);

// Save preference when toggle changes
document.getElementById('verbose-toggle').addEventListener('change', saveVerbosePreference);

// ── Activity Filter Pills ──────────────────────────────
const KNOWN_ACTIONS = ['Cached', 'Restored', 'Moved to Array', 'Protected'];

function getActiveFilter() {
    const active = document.querySelector('.activity-filter-pill.active');
    return active ? active.getAttribute('data-filter') : 'all';
}

function applyActivityFilter(filter) {
    const rows = document.querySelectorAll('#recent-activity tr[data-action]');
    rows.forEach(row => {
        const action = row.getAttribute('data-action');
        if (filter === 'all') {
            row.style.display = '';
        } else if (filter === 'other') {
            row.style.display = KNOWN_ACTIONS.includes(action) ? 'none' : '';
        } else {
            row.style.display = (action === filter) ? '' : 'none';
        }
    });

    // Show/hide date group headers based on visible rows in each group
    document.querySelectorAll('#recent-activity tr.date-group-header').forEach(header => {
        const dateKey = header.getAttribute('data-date-group');
        const groupRows = document.querySelectorAll(
            '#recent-activity tr[data-action][data-date-group="' + dateKey + '"]'
        );
        const anyVisible = Array.from(groupRows).some(r => r.style.display !== 'none');
        header.style.display = anyVisible ? '' : 'none';
    });
}

document.querySelector('.activity-filter-bar')?.addEventListener('click', function(e) {
    const pill = e.target.closest('.activity-filter-pill');
    if (!pill) return;
    document.querySelectorAll('.activity-filter-pill').forEach(p => p.classList.remove('active'));
    pill.classList.add('active');
    applyActivityFilter(pill.getAttribute('data-filter'));
});

// Re-apply filter after HTMX refreshes activity table
document.body.addEventListener('htmx:afterSwap', function(e) {
    if (e.detail.target && e.detail.target.id === 'recent-activity') {
        applyActivityFilter(getActiveFilter());
    }
});
</script>
{% endblock %}
