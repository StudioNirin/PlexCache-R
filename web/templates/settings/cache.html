{% extends "settings/index.html" %}

{% block settings_content %}
<div class="card">
    <div class="card-header">
        <i data-lucide="hard-drive"></i>
        <h2>Cache Behavior Settings</h2>
    </div>
    <div class="card-body">
        <form hx-put="/settings/cache" hx-target="#settings-alert-container" hx-swap="innerHTML">

            <h3 style="font-size: 1rem; color: var(--plex-orange); margin-bottom: 1rem;">
                <i data-lucide="bookmark" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                Watchlist
            </h3>

            <div class="form-group">
                <label class="switch">
                    <input type="checkbox" name="watchlist_toggle"
                           {% if settings.watchlist_toggle | default(true) %}checked{% endif %}>
                    <span>Enable Watchlist Caching</span>
                </label>
            </div>

            <div class="grid grid-2">
                <div class="form-group">
                    <label for="watchlist_episodes">Watchlist Episodes to Prefetch</label>
                    <input type="number" id="watchlist_episodes" name="watchlist_episodes"
                           value="{{ settings.watchlist_episodes | default(3) }}" min="0" max="10">
                </div>

                <div class="form-group">
                    <label for="watchlist_retention_days">Watchlist Retention (days)</label>
                    <input type="number" id="watchlist_retention_days" name="watchlist_retention_days"
                           value="{{ settings.watchlist_retention_days | default(14) }}" min="0" max="365" step="0.5">
                    <div class="form-hint">Auto-expire watchlist items after this period (0 = never expire)</div>
                </div>
            </div>

            <div class="form-group">
                <label class="switch">
                    <input type="checkbox" name="remote_watchlist_toggle"
                           {% if settings.remote_watchlist_toggle %}checked{% endif %}>
                    <span>Enable Remote Watchlist (RSS fallback)</span>
                </label>
            </div>

            <div class="form-group">
                <label for="remote_watchlist_rss_url">Remote Watchlist RSS URL</label>
                <input type="url" id="remote_watchlist_rss_url" name="remote_watchlist_rss_url"
                       value="{{ settings.remote_watchlist_rss_url | default('') }}"
                       placeholder="https://rss.plex.tv/...">
            </div>

            <hr style="border-color: var(--plex-border); margin: 1.5rem 0;">

            <h3 style="font-size: 1rem; color: var(--plex-orange); margin-bottom: 1rem;">
                <i data-lucide="hard-drive" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                Cache Management
            </h3>

            <div class="form-group">
                <label class="switch">
                    <input type="checkbox" name="watched_move"
                           {% if settings.watched_move | default(true) %}checked{% endif %}>
                    <span>Move Watched Files Back to Array</span>
                </label>
            </div>

            <div class="form-group">
                <label class="switch">
                    <input type="checkbox" name="create_plexcached_backups"
                           {% if settings.create_plexcached_backups | default(true) %}checked{% endif %}>
                    <span>Create .plexcached Backup Files</span>
                </label>
                <div class="form-hint">When moving files to cache, keep backup on array (allows recovery if cache fails)</div>
            </div>

            <div class="form-group">
                <label for="hardlinked_files">Hardlinked Files Handling</label>
                <select id="hardlinked_files" name="hardlinked_files">
                    <option value="skip" {% if settings.hardlinked_files == 'skip' or not settings.hardlinked_files %}selected{% endif %}>Skip (preserve for seeders)</option>
                    <option value="move" {% if settings.hardlinked_files == 'move' %}selected{% endif %}>Move (break hardlinks)</option>
                </select>
                <div class="form-hint">Files with multiple hardlinks (e.g., seeding torrents). Skip preserves links, Move copies the file.</div>
            </div>

            <div class="grid grid-2">
                <div class="form-group">
                    <label for="cache_retention_hours">Cache Retention (hours)</label>
                    <input type="number" id="cache_retention_hours" name="cache_retention_hours"
                           value="{{ settings.cache_retention_hours | default(12) }}" min="0" max="720">
                    <div class="form-hint">Keep files cached at least this long (0 = no minimum)</div>
                </div>

                <div class="form-group">
                    <label for="cache_limit">Cache Limit</label>
                    <input type="text" id="cache_limit" name="cache_limit"
                           value="{{ settings.cache_limit | default('250GB') }}"
                           placeholder="500GB or 75%"
                           oninput="updateCacheCalculations()">
                    <div class="form-hint">Stop caching new files when drive usage exceeds this (e.g., 500GB or 75%)</div>
                    <div id="cache_limit_calculated" class="form-hint" style="color: var(--plex-orange); margin-top: 0.25rem;"></div>
                </div>
            </div>

            <hr style="border-color: var(--plex-border); margin: 1.5rem 0;">

            <h3 style="font-size: 1rem; color: var(--plex-orange); margin-bottom: 1rem;">
                <i data-lucide="trash-2" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                Eviction
            </h3>

            <div class="form-group">
                <label for="cache_eviction_mode">Eviction Mode</label>
                <select id="cache_eviction_mode" name="cache_eviction_mode">
                    <option value="smart" {% if settings.cache_eviction_mode == 'smart' %}selected{% endif %}>Smart (priority-based)</option>
                    <option value="fifo" {% if settings.cache_eviction_mode == 'fifo' %}selected{% endif %}>FIFO (oldest first)</option>
                    <option value="none" {% if settings.cache_eviction_mode == 'none' %}selected{% endif %}>None (manual only)</option>
                </select>
            </div>

            <div class="grid grid-2">
                <div class="form-group">
                    <label for="cache_eviction_threshold_percent">Eviction Threshold (%)</label>
                    <input type="number" id="cache_eviction_threshold_percent" name="cache_eviction_threshold_percent"
                           value="{{ settings.cache_eviction_threshold_percent | default(95) }}" min="50" max="100"
                           oninput="updateCacheCalculations()">
                    <div class="form-hint">Start evicting when drive usage exceeds this % of Cache Limit</div>
                    <div id="eviction_threshold_calculated" class="form-hint" style="color: var(--plex-orange); margin-top: 0.25rem;"></div>
                </div>

                <div class="form-group">
                    <label for="eviction_min_priority">Minimum Priority to Keep</label>
                    <input type="number" id="eviction_min_priority" name="eviction_min_priority"
                           value="{{ settings.eviction_min_priority | default(60) }}" min="0" max="100">
                    <div class="form-hint">Only evict files below this priority (OnDeck ~90, Watchlist ~70)</div>
                </div>
            </div>

            <hr style="border-color: var(--plex-border); margin: 1.5rem 0;">

            <h3 style="font-size: 1rem; color: var(--plex-orange); margin-bottom: 1rem;">
                <i data-lucide="activity" style="width: 18px; height: 18px; vertical-align: middle;"></i>
                Dashboard
            </h3>

            <div class="form-group">
                <label for="activity_retention_hours">Recent Activity Retention (hours)</label>
                <select id="activity_retention_hours" name="activity_retention_hours">
                    <option value="12" {% if settings.activity_retention_hours == 12 %}selected{% endif %}>12 hours</option>
                    <option value="24" {% if settings.activity_retention_hours == 24 or not settings.activity_retention_hours %}selected{% endif %}>24 hours (default)</option>
                    <option value="48" {% if settings.activity_retention_hours == 48 %}selected{% endif %}>48 hours</option>
                    <option value="72" {% if settings.activity_retention_hours == 72 %}selected{% endif %}>3 days</option>
                    <option value="168" {% if settings.activity_retention_hours == 168 %}selected{% endif %}>7 days</option>
                </select>
                <div class="form-hint">How long to keep Recent Activity entries on the Dashboard</div>
            </div>

            <div class="form-group mb-0">
                <button type="submit" class="btn btn-primary">
                    <i data-lucide="save"></i>
                    Save Cache Settings
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Drive info from server
const driveTotalBytes = {{ drive_info.total_bytes | default(0) }};
const driveTotalDisplay = "{{ drive_info.total_display | default('Unknown') }}";

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const gb = bytes / (1024 * 1024 * 1024);
    if (gb >= 1024) {
        return (gb / 1024).toFixed(2) + ' TB';
    }
    return gb.toFixed(1) + ' GB';
}

function parseCacheLimit(value) {
    if (!value) return 0;
    value = value.toString().trim();

    // Check if percentage
    if (value.endsWith('%')) {
        const percent = parseFloat(value);
        if (!isNaN(percent) && driveTotalBytes > 0) {
            return Math.round(driveTotalBytes * percent / 100);
        }
        return 0;
    }

    // Parse absolute size (e.g., "500GB", "1TB", "1.5T")
    const match = value.match(/^([\d.]+)\s*(TB?|GB?|MB?)?$/i);
    if (match) {
        const num = parseFloat(match[1]);
        const unit = (match[2] || 'GB').toUpperCase();
        if (unit.startsWith('T')) return Math.round(num * 1024 * 1024 * 1024 * 1024);
        if (unit.startsWith('G')) return Math.round(num * 1024 * 1024 * 1024);
        if (unit.startsWith('M')) return Math.round(num * 1024 * 1024);
    }
    return 0;
}

function updateCacheCalculations() {
    const cacheLimitInput = document.getElementById('cache_limit');
    const evictionThresholdInput = document.getElementById('cache_eviction_threshold_percent');
    const cacheLimitCalc = document.getElementById('cache_limit_calculated');
    const evictionThresholdCalc = document.getElementById('eviction_threshold_calculated');

    const cacheLimitValue = cacheLimitInput.value;
    const evictionPercent = parseInt(evictionThresholdInput.value) || 95;

    // Calculate cache limit bytes
    const cacheLimitBytes = parseCacheLimit(cacheLimitValue);

    // Update cache limit display
    if (cacheLimitBytes > 0) {
        if (cacheLimitValue.includes('%') && driveTotalBytes > 0) {
            cacheLimitCalc.textContent = `= ${formatBytes(cacheLimitBytes)} of ${driveTotalDisplay} drive`;
        } else if (driveTotalBytes > 0) {
            const percent = (cacheLimitBytes / driveTotalBytes * 100).toFixed(1);
            cacheLimitCalc.textContent = `= ${percent}% of ${driveTotalDisplay} drive`;
        } else {
            cacheLimitCalc.textContent = `= ${formatBytes(cacheLimitBytes)}`;
        }

        // Calculate and show eviction threshold
        const evictionBytes = Math.round(cacheLimitBytes * evictionPercent / 100);
        evictionThresholdCalc.textContent = `= ${formatBytes(evictionBytes)} (${evictionPercent}% of ${formatBytes(cacheLimitBytes)})`;
    } else {
        cacheLimitCalc.textContent = '';
        evictionThresholdCalc.textContent = '';
    }
}

// Run on page load
document.addEventListener('DOMContentLoaded', updateCacheCalculations);
</script>
{% endblock %}
