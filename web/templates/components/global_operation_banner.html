<!-- Global Operation Banner — compact pill style -->
<!-- Compact pill by default, expands on hover/click. Color-coded by operation type. -->

<!-- Banner warning helper — expands a warning row inside the active pill -->
<script>
function showBannerWarning(message) {
    var warning = document.getElementById('di-warning');
    var pill = document.querySelector('.di-pill');
    var textEl = document.getElementById('di-warning-text');
    if (!warning || !pill || !textEl) return;
    textEl.textContent = message;
    // Slow HTMX polling so warning isn't replaced before user sees it
    var pollEl = document.querySelector('#global-operation-banner [hx-trigger]');
    if (pollEl) { pollEl.setAttribute('hx-trigger', 'every 8s'); htmx.process(pollEl); }
    requestAnimationFrame(function() { requestAnimationFrame(function() {
        warning.style.maxHeight = '2.5rem';
        warning.style.maxWidth = '40rem';
        warning.style.opacity = '1';
        warning.style.paddingTop = '0.6rem';
        warning.style.marginTop = '0.6rem';
        warning.style.borderColor = 'rgba(230, 126, 34, 0.3)';
    }); });
    setTimeout(function() {
        if (!warning) return;
        warning.style.maxHeight = '0';
        warning.style.maxWidth = '0';
        warning.style.opacity = '0';
        warning.style.paddingTop = '0';
        warning.style.marginTop = '0';
        warning.style.borderColor = 'transparent';
    }, 4000);
}

/* ── Expand/Collapse interaction ───────────────────────────────────────
   Expansion state is stored as data-di-expanded on the OUTER
   #global-operation-banner div (NOT replaced by HTMX innerHTML swaps).
   CSS reads this attribute directly — no JS class reapplication needed,
   so there's zero flicker when HTMX polls replace the inner content. */

function diGetExpandState() {
    var outer = document.getElementById('global-operation-banner');
    return outer ? (outer.getAttribute('data-di-expanded') || 'false') : 'false';
}
function diSetExpandState(state) {
    var outer = document.getElementById('global-operation-banner');
    if (outer) outer.setAttribute('data-di-expanded', state);
    // Also apply classes for JS-generated pills (completion banners)
    var pill = document.querySelector('#global-operation-banner .di-pill');
    if (pill) {
        pill.classList.remove('di-expanded', 'di-detail');
        if (state === 'tier2') pill.classList.add('di-expanded');
        if (state === 'tier3') { pill.classList.add('di-expanded'); pill.classList.add('di-detail'); }
    }
}

/* ── FLIP animation engine ───────────────────────────────────────
   Smooth expand/collapse inspired by Apple Dynamic Island.
   Uses FLIP (First-Last-Invert-Play) to animate display:none swaps.
   diSetExpandState (above) is the instant/raw setter — used by
   dismiss handlers, session restore, and HTMX callbacks.
   diSmoothSetState (below) is the animated version — used by
   hover, click, and minimize interactions only. */

var _FLIP_EXPAND  = 380;   /* expand duration ms */
var _FLIP_COLLAPSE = 280;  /* collapse duration ms */
var _FLIP_EXIT_OVERLAP = 100;  /* start FLIP this many ms into exit animation */
var _FLIP_EASE_EXPAND  = 'cubic-bezier(0.34, 1.56, 0.64, 1)';  /* spring overshoot */
var _FLIP_EASE_COLLAPSE = 'cubic-bezier(0.4, 0, 0.2, 1)';       /* snappy settle */

function diSmoothSetState(state) {
    var outer = document.getElementById('global-operation-banner');
    var pill = outer ? outer.querySelector('.di-pill') : null;
    if (!outer || !pill) { diSetExpandState(state); return; }

    var currentState = diGetExpandState();
    if (currentState === state) return;

    /* Cancel any in-flight animations (stored on outer — survives HTMX swaps) */
    if (outer._flipCleanup) { outer._flipCleanup(); outer._flipCleanup = null; }
    if (outer._exitTimeout) { clearTimeout(outer._exitTimeout); outer._exitTimeout = null; }

    var tiers = { 'false': 0, 'tier2': 1, 'tier3': 2 };
    var isExpanding = tiers[state] > tiers[currentState];

    if (isExpanding) {
        /* ── EXPAND: FLIP immediately ── */
        _diDoFlip(outer, pill, currentState, state, true);
    } else {
        /* ── COLLAPSE: exit-animate content, then FLIP after overlap ── */
        var isDetailOnly = (currentState === 'tier3' && state === 'tier2');
        var exitTarget = isDetailOnly
            ? pill.querySelector('.di-pill__detail')
            : pill.querySelector('.di-pill__expanded');

        /* Play exit animation (reverse of enter: scale 1→0.92, opacity 1→0) */
        if (exitTarget) {
            exitTarget.classList.remove('di-content-enter', 'di-content-exit');
            void exitTarget.offsetWidth;
            exitTarget.classList.add('di-content-exit');
        }

        /* Hide progress bar immediately so it can't slide during collapse */
        var pb = pill.querySelector('.di-pill__progress');
        if (pb) { pb.style.transition = 'none'; pb.style.opacity = '0'; }

        /* Start FLIP partway through exit — they overlap seamlessly */
        outer._exitTimeout = setTimeout(function() {
            outer._exitTimeout = null;
            var freshPill = outer.querySelector('.di-pill');
            if (!freshPill) { diSetExpandState(state); return; }
            if (exitTarget) exitTarget.classList.remove('di-content-exit');
            _diDoFlip(outer, freshPill, currentState, state, false);
        }, _FLIP_EXIT_OVERLAP);
    }
}

function _diDoFlip(outer, pill, fromState, toState, isExpanding) {
    var duration = isExpanding ? _FLIP_EXPAND : _FLIP_COLLAPSE;
    var easing = isExpanding ? _FLIP_EASE_EXPAND : _FLIP_EASE_COLLAPSE;

    /* 1. Snapshot ALL dimensional properties */
    var cs = getComputedStyle(pill);
    var startHeight = pill.offsetHeight;
    var startBorderRadius = cs.borderRadius;
    var startPaddingTop = cs.paddingTop;
    var startPaddingBottom = cs.paddingBottom;
    var startMinWidth = cs.minWidth;

    /* 2. Freeze — lock current dimensions, hide progress bar */
    var progressBar = pill.querySelector('.di-pill__progress');
    if (progressBar && isExpanding) {
        progressBar.style.transition = 'none';
        progressBar.style.opacity = '0';
    }
    pill.style.willChange = 'height, border-radius, padding, min-width';
    pill.style.transition = 'none';
    pill.style.height = startHeight + 'px';
    pill.style.borderRadius = startBorderRadius;
    pill.style.paddingTop = startPaddingTop;
    pill.style.paddingBottom = startPaddingBottom;
    pill.style.minWidth = startMinWidth;
    pill.style.overflow = 'hidden';

    /* 3. Swap state — CSS display:none swap happens here */
    diSetExpandState(toState);

    /* 4. Measure target — temporarily clear overrides to read CSS end values */
    pill.style.height = 'auto';
    pill.style.borderRadius = '';
    pill.style.paddingTop = '';
    pill.style.paddingBottom = '';
    pill.style.minWidth = '';
    var endCs = getComputedStyle(pill);
    var endHeight = pill.offsetHeight;
    var endBorderRadius = endCs.borderRadius;
    var endPaddingTop = endCs.paddingTop;
    var endPaddingBottom = endCs.paddingBottom;
    var endMinWidth = endCs.minWidth;

    /* 5. Rewind ALL to start values */
    pill.style.height = startHeight + 'px';
    pill.style.borderRadius = startBorderRadius;
    pill.style.paddingTop = startPaddingTop;
    pill.style.paddingBottom = startPaddingBottom;
    pill.style.minWidth = startMinWidth;

    /* 6. Force reflow */
    pill.offsetHeight;

    /* 7. Animate ALL dimensional properties (spring easing) */
    var animProps = ['height', 'border-radius', 'padding-top', 'padding-bottom', 'min-width'];
    pill.style.transition = animProps.map(function(p) {
        return p + ' ' + duration + 'ms ' + easing;
    }).join(', ');
    pill.style.height = endHeight + 'px';
    pill.style.borderRadius = endBorderRadius;
    pill.style.paddingTop = endPaddingTop;
    pill.style.paddingBottom = endPaddingBottom;
    pill.style.minWidth = endMinWidth;

    /* 8. Content transitions */
    if (isExpanding) {
        var enterTarget = (fromState === 'tier2' && toState === 'tier3')
            ? pill.querySelector('.di-pill__detail')
            : pill.querySelector('.di-pill__expanded');
        if (enterTarget) {
            enterTarget.classList.remove('di-content-enter');
            void enterTarget.offsetWidth;
            enterTarget.classList.add('di-content-enter');
        }
    } else {
        /* Collapse: settle-fade compact content, progress bar fades in last 45% */
        var compact = pill.querySelector('.di-pill__compact');
        if (compact) {
            compact.classList.remove('di-content-settle');
            void compact.offsetWidth;
            compact.classList.add('di-content-settle');
        }
        if (progressBar) {
            setTimeout(function() {
                progressBar.style.transition = 'opacity ' + Math.round(duration * 0.45) + 'ms ease';
                progressBar.style.opacity = '';
            }, Math.round(duration * 0.55));
        }
    }

    /* 9. Cleanup — remove ALL inline overrides so CSS takes over */
    function cleanup() {
        pill.style.height = '';
        pill.style.borderRadius = '';
        pill.style.paddingTop = '';
        pill.style.paddingBottom = '';
        pill.style.minWidth = '';
        pill.style.overflow = '';
        pill.style.transition = '';
        pill.style.willChange = '';
        if (progressBar) {
            if (isExpanding) {
                progressBar.style.transition = '';
                progressBar.style.opacity = '';
            } else {
                setTimeout(function() { progressBar.style.transition = ''; }, 50);
            }
        }
        var c = pill.querySelector('.di-pill__compact');
        if (c) c.classList.remove('di-content-settle');
        var e = pill.querySelector('.di-pill__expanded');
        if (e) e.classList.remove('di-content-enter');
        outer._flipCleanup = null;
        pill.removeEventListener('transitionend', onEnd);
    }
    function onEnd(e) { if (e.propertyName === 'height' && e.target === pill) cleanup(); }
    pill.addEventListener('transitionend', onEnd);
    outer._flipCleanup = cleanup;
    setTimeout(function() { if (outer._flipCleanup) outer._flipCleanup(); }, duration + 50);
}

function diMinimize() { diSmoothSetState('false'); }

var _diHoverTimer = null;
var _diLeaveTimer = null;
function diHoverIn() {
    clearTimeout(_diLeaveTimer);
    if (diGetExpandState() === 'false') {
        _diHoverTimer = setTimeout(function() { diSmoothSetState('tier2'); }, 200);
    }
}
function diHoverOut() {
    clearTimeout(_diHoverTimer);
    if (diGetExpandState() === 'tier2') {
        _diLeaveTimer = setTimeout(function() {
            if (diGetExpandState() === 'tier2') diSmoothSetState('false');
        }, 300);
    }
}
function diPillClick() {
    var state = diGetExpandState();
    if (state === 'false') diSmoothSetState('tier2');
    else if (state === 'tier2') diSmoothSetState('tier3');
    else diSmoothSetState('false');  /* tier3 → collapse back to compact */
}

// After every HTMX swap: re-render icons, sync animations, one-shot entrance
document.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target && evt.detail.target.id === 'global-operation-banner') {
        if (typeof lucide !== 'undefined') lucide.createIcons();

        // Sync looping animations to wall clock so they don't visibly reset on 2s swap.
        // A negative animation-delay makes the new element start mid-cycle at the
        // exact phase the old element was at before it was replaced.
        var now = Date.now();
        document.querySelectorAll('#global-operation-banner .di-spinner').forEach(function(el) {
            el.style.animationDelay = -(now % 800) + 'ms';   // 800ms spin cycle
        });
        document.querySelectorAll('#global-operation-banner .di-action-tag--active').forEach(function(el) {
            el.style.animationDelay = -(now % 1500) + 'ms';  // 1500ms pulse cycle
        });

        // Detect state changes — only animate entrance when the banner state actually changes
        var outer = document.getElementById('global-operation-banner');
        var pill = outer ? outer.querySelector('.di-pill') : null;
        if (pill && outer) {
            var newState = pill.getAttribute('data-state') || pill.className;
            var prevState = outer.getAttribute('data-di-prev-state') || '';
            if (newState !== prevState) {
                outer.setAttribute('data-di-prev-state', newState);
                pill.classList.add('di-pill--entrance');
                pill.addEventListener('animationend', function() { pill.classList.remove('di-pill--entrance'); }, { once: true });
            }
        }

        // Re-inject live log lines from WebSocket buffer (overwrites stale server data)
        if (window.BannerLogStream) BannerLogStream.renderIfVisible();
    }
});
</script>

{% if maint_status is defined and maint_status.state == 'running' %}
{# ═══════════════════════════════════════════════════════════
   MAINTENANCE RUNNING — Cyan pill
   ═══════════════════════════════════════════════════════════ #}
{% set color_mod = 'maintenance' %}
{% set poll_interval = '8s' if (blocked_message is defined and blocked_message) else '2s' %}
<div class="di-pill di-pill--{{ color_mod }} di-glow" data-state="maint-running"
     hx-get="/api/operation-banner" hx-trigger="every {{ poll_interval }}" hx-swap="innerHTML" hx-target="#global-operation-banner"
     onmouseenter="diHoverIn()" onmouseleave="diHoverOut()" onclick="diPillClick()">

    <!-- Compact view -->
    <div class="di-pill__compact">
        <div class="di-pill__left">
            <div class="di-icon"><i data-lucide="wrench" style="width: 14px; height: 14px;"></i></div>
            <span class="di-label">{{ maint_status.action_display|truncate(32, True, '...') }}</span>
            <div class="di-spinner"></div>
            {% if maint_status.queue_count is defined and maint_status.queue_count > 0 %}
            <span class="di-queue-badge">+{{ maint_status.queue_count }}</span>
            {% endif %}
        </div>
        <div class="di-pill__right">
            {% if maint_status.file_count and maint_status.file_count > 0 %}
            <span class="di-metric">{{ maint_status.files_processed }}/{{ maint_status.file_count }}</span>
            {% else %}
            <span class="di-metric">{{ maint_status.elapsed_display }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Expanded view (Tier 2) -->
    <div class="di-pill__expanded">
        <div class="di-expanded__header">
            <div class="di-expanded__header-left">
                <div class="di-icon"><i data-lucide="wrench" style="width: 14px; height: 14px;"></i></div>
                <span class="di-label">{{ maint_status.action_display }}</span>
                <div class="di-spinner"></div>
            </div>
            <div class="di-expanded__header-right">
                <button class="di-stop" title="Stop"
                        hx-post="/maintenance/stop-action" hx-target="#global-operation-banner" hx-swap="innerHTML"
                        onclick="event.stopPropagation()">
                    <div class="di-stop__inner"></div>
                </button>
                <button class="di-dismiss" title="Minimize" onclick="event.stopPropagation(); diMinimize();">&minus;</button>
            </div>
        </div>
        {% if maint_status.file_count and maint_status.file_count > 0 %}
        <div class="di-progress-track"><div class="di-progress-fill" style="width: {{ maint_status.progress_percent }}%;"></div></div>
        <div class="di-progress-meta">
            <span>{{ maint_status.files_processed }}/{{ maint_status.file_count }} files
                {%- if maint_status.parallel %} <span style="color: rgba(255,255,255,0.25);">({{ maint_status.parallel }}&times;)</span>{% endif %}
                {%- if not maint_status.parallel and maint_status.current_file %} &mdash; {{ maint_status.current_file|truncate(50, True, '...') }}{% endif %}</span>
            <span class="di-progress-meta__right">
                {%- if maint_status.bytes_display %}{{ maint_status.bytes_display }} &middot; {% endif %}
                {{- maint_status.elapsed_display }}
                {%- if maint_status.eta_display %} | ~{{ maint_status.eta_display }} left{% endif %}</span>
        </div>
        {% endif %}
        {% if maint_status.active_files or (maint_status.queue_count is defined and maint_status.queue_count > 0) %}
        <!-- Tier 2 hint: click to expand detail panel -->
        <div class="di-expand-hint">
            <span>Click for details</span>
            <i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i>
        </div>
        <!-- Detail: active files + queue (Tier 3) -->
        <div class="di-pill__detail">
            {%- if maint_status.active_files %}
            <div class="di-divider"></div>
            {%- for f in maint_status.active_files %}
            <div class="di-file-row">
                <span style="color: rgba(255,255,255,0.2);">&#8627;</span>
                <span class="di-file-row__name">{{ f|truncate(65, True, '...') }}</span>
            </div>
            {%- endfor %}
            {%- endif %}
            {%- if maint_status.queue_count is defined and maint_status.queue_count > 0 %}
            <div class="di-divider"></div>
            <div class="di-queue-section">
                <div class="di-queue-header">
                    <span class="di-queue-header__label">Queue ({{ maint_status.queue_count }})</span>
                    <button class="di-queue-header__clear" title="Clear queue"
                            onclick="event.stopPropagation(); fetch('/maintenance/queue/clear',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">
                        Clear
                    </button>
                </div>
                {%- for item in maint_status.queue %}
                <div class="di-queue-item">
                    <span class="di-action-tag di-action-tag--queued">QUEUED</span>
                    <span class="di-queue-item__name">{{ item.display_name }}</span>
                    {% if item.file_count %}<span class="di-queue-item__count">{{ item.file_count }} files</span>{% endif %}
                    <button class="di-queue-item__remove" title="Remove"
                            onclick="event.stopPropagation(); fetch('/maintenance/queue/remove/{{ item.id }}',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">
                        &times;
                    </button>
                </div>
                {%- endfor %}
            </div>
            {%- endif %}
        </div>
        {% endif %}
        <!-- Warning row -->
        <div id="di-warning" class="di-warning">
            <i data-lucide="alert-triangle" style="width: 14px; height: 14px; color: #e67e22; flex-shrink: 0;"></i>
            <span id="di-warning-text" style="font-size: 0.8rem; color: #e67e22; white-space: nowrap;"></span>
        </div>
    </div>

    {% if maint_status.file_count and maint_status.file_count > 0 %}
    <div class="di-pill__progress" style="width: {{ maint_status.progress_percent }}%;"></div>
    {% endif %}
</div>
<script>
    lucide.createIcons();
    if (window.BannerLogStream) BannerLogStream.disconnect();
    {% if blocked_message is defined and blocked_message %}showBannerWarning('{{ blocked_message }}');{% endif %}
</script>

{% elif maint_status is defined and maint_status.state == 'completed' %}
{# ═══════════════════════════════════════════════════════════
   MAINTENANCE COMPLETED — Green or orange pill
   ═══════════════════════════════════════════════════════════ #}
<script>
(function() {
    var completionKey = 'plexcache_last_maint_completion_shown';
    var completionId = '{{ maint_status.completed_at or maint_status.duration_seconds }}';
    var isRepoll = (sessionStorage.getItem(completionKey) === completionId);
    sessionStorage.setItem(completionKey, completionId);

    var maintErrors = {{ maint_status.errors|length if maint_status.errors is defined else 0 }};
    var colorMod = maintErrors > 0 ? 'completed-errors' : 'completed';
    var iconName = maintErrors > 0 ? 'alert-triangle' : 'check';
    var resultMsg = '{{ maint_status.result_message | default("Action completed") }}';
    var duration = '{{ maint_status.elapsed_display|default(maint_status.duration_seconds ~ "s") }}';
    var affectedCount = {{ maint_status.affected_count|default(0) }};
    var errorBadge = maintErrors > 0 ? '<span class="di-error-badge">' + maintErrors + ' error' + (maintErrors !== 1 ? 's' : '') + '</span>' : '';

    // Build file list for detail panel
    var affectedFiles = [
        {% for f in maint_status.affected_files|default([]) %}
        '{{ f|truncate(60, True, "...")|e }}',
        {% endfor %}
    ];
    var detailHtml = '';
    var hintHtml = '';
    if (affectedFiles.length > 0) {
        hintHtml = '<div class="di-expand-hint"><span>Click for details</span><i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i></div>';
        detailHtml = '<div class="di-pill__detail"><div class="di-divider"></div>';
        affectedFiles.forEach(function(f) {
            detailHtml += '<div class="di-file-row"><span style="color: rgba(255,255,255,0.2);">&#8627;</span><span class="di-file-row__name">' + f + '</span></div>';
        });
        if (affectedCount > affectedFiles.length) {
            detailHtml += '<div class="di-more-files">+ ' + (affectedCount - affectedFiles.length) + ' more files</div>';
        }
        detailHtml += '</div>';
    }

    document.getElementById('global-operation-banner').innerHTML = `
        <div class="di-pill di-pill--${colorMod}" data-state="maint-completed"
             hx-get="/api/operation-banner" hx-trigger="every 10s" hx-swap="innerHTML" hx-target="#global-operation-banner"
             onmouseenter="diHoverIn()" onmouseleave="diHoverOut()" onclick="diPillClick()">
            <div class="di-pill__compact">
                <div class="di-pill__left">
                    <div class="di-icon"><i data-lucide="${iconName}" style="width: 14px; height: 14px;"></i></div>
                    <span class="di-label">Maintenance Complete</span>
                    ${errorBadge}
                </div>
                <div class="di-pill__right">
                    <span class="di-metric--muted">${resultMsg}</span>
                    <span class="di-metric" style="font-size: 0.78rem;">${duration}</span>
                </div>
            </div>
            <div class="di-pill__expanded">
                <div class="di-expanded__header">
                    <div class="di-expanded__header-left">
                        <div class="di-icon"><i data-lucide="${iconName}" style="width: 14px; height: 14px;"></i></div>
                        <span class="di-label">Maintenance Complete</span>
                        ${errorBadge}
                        <span class="di-metric--muted">${duration}</span>
                    </div>
                    <div class="di-expanded__header-right">
                        <button class="di-dismiss" title="Dismiss" onclick="event.stopPropagation(); dismissMaintCompletionBanner();">&times;</button>
                    </div>
                </div>
                <div style="font-size: 0.78rem; color: rgba(255,255,255,0.5);">${resultMsg}</div>
                ${hintHtml}
                ${detailHtml}
            </div>
        </div>`;
    lucide.createIcons();
    htmx.process(document.getElementById('global-operation-banner'));
    // Apply expansion class to JS-generated pill (CSS attribute selectors also apply)
    var _st = diGetExpandState(), _p = document.querySelector('#global-operation-banner .di-pill');
    if (_p) { if (_st === 'tier2') _p.classList.add('di-expanded'); if (_st === 'tier3') { _p.classList.add('di-expanded','di-detail'); } }

    // Auto-dismiss after 10s in compact; collapse back to compact restarts the timer
    var _ob = document.getElementById('global-operation-banner');
    if (_ob) {
        if (_ob._compObs) _ob._compObs.disconnect();
        if (!isRepoll) {
            clearTimeout(_ob._compTimer);
            if (diGetExpandState() === 'false') {
                _ob._compTimer = setTimeout(function() {
                    if (diGetExpandState() === 'false') dismissMaintCompletionBanner();
                }, 10000);
            }
        }
        _ob._compObs = new MutationObserver(function() {
            clearTimeout(_ob._compTimer);
            if (diGetExpandState() === 'false') {
                _ob._compTimer = setTimeout(function() {
                    if (diGetExpandState() === 'false') dismissMaintCompletionBanner();
                }, 10000);
            }
        });
        _ob._compObs.observe(_ob, { attributes: true, attributeFilter: ['data-di-expanded'] });
    }

    // Handle "stuck" expanded state from running→completed transition.
    // When innerHTML is swapped under a stationary cursor, browsers don't fire
    // mouseleave on the new pill (mouseenter was never tracked). Detect this
    // on the next mouse movement and collapse if the cursor has already left.
    if (diGetExpandState() !== 'false') {
        document.addEventListener('mousemove', function() {
            var p = document.querySelector('#global-operation-banner .di-pill');
            if (p && !p.matches(':hover') && diGetExpandState() !== 'false') {
                diSmoothSetState('false');
            }
        }, { once: true });
    }

    // Auto-refresh audit content if on maintenance page
    var auditContent = document.getElementById('audit-content');
    if (auditContent) {
        htmx.ajax('GET', '/maintenance/audit?refresh=true', {target: '#audit-content', swap: 'innerHTML'});
    }

})();

function dismissMaintCompletionBanner() {
    var pill = document.querySelector('#global-operation-banner .di-pill');
    diSetExpandState('false');  /* Reset so idle pill doesn't inherit expanded layout */
    sessionStorage.removeItem('plexcache_nextrun_dismissed');
    if (pill && pill.style.opacity !== '0') {
        pill.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
        pill.style.opacity = '0';
        pill.style.transform = 'translateY(-20px)';
        setTimeout(function() {
            fetch('/maintenance/dismiss-action', { method: 'POST' });
            document.getElementById('global-operation-banner').innerHTML =
                '<div hx-get="/api/operation-banner" hx-trigger="every 10s" hx-swap="innerHTML" hx-target="#global-operation-banner"></div>';
            htmx.process(document.getElementById('global-operation-banner'));
        }, 400);
    }
}
</script>

{% elif maint_status is defined and maint_status.state == 'failed' %}
{# ═══════════════════════════════════════════════════════════
   MAINTENANCE FAILED — Red pill
   ═══════════════════════════════════════════════════════════ #}
<div class="di-pill di-pill--error" data-state="maint-failed"
     onmouseenter="diHoverIn()" onmouseleave="diHoverOut()" onclick="diPillClick()">
    <div class="di-pill__compact">
        <div class="di-pill__left">
            <div class="di-icon"><i data-lucide="x-circle" style="width: 14px; height: 14px;"></i></div>
            <span class="di-label">Maintenance Failed</span>
        </div>
        <div class="di-pill__right">
            {% if maint_status.error_message %}
            <span class="di-metric--muted" style="max-width: 180px; overflow: hidden; text-overflow: ellipsis;">{{ maint_status.error_message|truncate(30, True, '...') }}</span>
            {% endif %}
            <button class="di-dismiss" title="Dismiss"
                    onclick="event.stopPropagation(); fetch('/maintenance/dismiss-action',{method:'POST'}); document.getElementById('global-operation-banner').innerHTML='<div hx-get=/api/operation-banner hx-trigger=every\ 10s hx-swap=innerHTML hx-target=#global-operation-banner></div>'; htmx.process(document.getElementById('global-operation-banner'));">&times;</button>
        </div>
    </div>
    <div class="di-pill__expanded">
        <div class="di-expanded__header">
            <div class="di-expanded__header-left">
                <div class="di-icon"><i data-lucide="x-circle" style="width: 14px; height: 14px;"></i></div>
                <span class="di-label">Maintenance Failed</span>
            </div>
            <div class="di-expanded__header-right">
                <button class="di-dismiss" title="Dismiss"
                        onclick="event.stopPropagation(); fetch('/maintenance/dismiss-action',{method:'POST'}); document.getElementById('global-operation-banner').innerHTML='<div hx-get=/api/operation-banner hx-trigger=every\ 10s hx-swap=innerHTML hx-target=#global-operation-banner></div>'; htmx.process(document.getElementById('global-operation-banner'));">&times;</button>
            </div>
        </div>
        {% if maint_status.error_message %}
        <div style="font-size: 0.78rem; color: rgba(255,255,255,0.5);">{{ maint_status.error_message }}</div>
        {% endif %}
    </div>
</div>
<script>lucide.createIcons();</script>

{% elif status.state == 'running' %}
{# ═══════════════════════════════════════════════════════════
   OPERATION RUNNING — Green (caching) or Orange (evicting) pill
   ═══════════════════════════════════════════════════════════ #}
{% set phase = status.phase|default(status.current_phase|default('starting')) %}
{% if status.dry_run %}
  {% set color_mod = 'dry-run' %}
  {% set icon_name = 'eye' %}
  {% set phase_label = 'Dry Run' %}
{% elif phase in ('restoring', 'evicting') %}
  {% set color_mod = 'evicting' %}
  {% set icon_name = 'cloud-upload' %}
  {% set phase_label = status.current_phase_display|default('Restoring...') %}
{% else %}
  {% set color_mod = 'caching' %}
  {% set icon_name = 'cloud-download' %}
  {% set phase_label = status.current_phase_display|default('Caching...') %}
{% endif %}
{% set poll_interval = '8s' if (blocked_message is defined and blocked_message) else '2s' %}

<div class="di-pill di-pill--{{ color_mod }} di-glow" data-state="op-running-{{ color_mod }}"
     hx-get="/api/operation-banner" hx-trigger="every {{ poll_interval }}" hx-swap="innerHTML" hx-target="#global-operation-banner"
     onmouseenter="diHoverIn()" onmouseleave="diHoverOut()" onclick="diPillClick()">

    <!-- Compact view -->
    <div class="di-pill__compact">
        <div class="di-pill__left">
            <div class="di-icon"><i data-lucide="{{ icon_name }}" style="width: 14px; height: 14px;"></i></div>
            <span class="di-label">{{ phase_label|truncate(20, True, '...') }}</span>
            <div class="di-spinner"></div>
            {% if status.error_count is defined and status.error_count > 0 %}
            <span class="di-error-badge">{{ status.error_count }}</span>
            {% endif %}
            {% if maint_status is defined and maint_status.queue_count is defined and maint_status.queue_count > 0 %}
            <span class="di-queue-badge">+{{ maint_status.queue_count }}</span>
            {% endif %}
        </div>
        <div class="di-pill__right">
            {% if status.total_files is defined and status.total_files > 0 %}
            <span class="di-metric">{{ status.completed_files }}/{{ status.total_files }}</span>
            {% elif status.elapsed_display is defined %}
            <span class="di-metric">{{ status.elapsed_display }}</span>
            {% endif %}
        </div>
    </div>

    <!-- Expanded view (Tier 2) -->
    <div class="di-pill__expanded">
        <div class="di-expanded__header">
            <div class="di-expanded__header-left">
                <div class="di-icon"><i data-lucide="{{ icon_name }}" style="width: 14px; height: 14px;"></i></div>
                <span class="di-label">{{ phase_label }}</span>
                <div class="di-spinner"></div>
                {% if status.error_count is defined and status.error_count > 0 %}
                <span class="di-error-badge">{{ status.error_count }} error{{ 's' if status.error_count != 1 }}</span>
                {% endif %}
            </div>
            <div class="di-expanded__header-right">
                <a href="/logs?live=true" class="di-dismiss" title="View logs" onclick="event.stopPropagation();" style="text-decoration: none;">
                    <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
                </a>
                <button class="di-stop" title="Stop"
                        hx-post="/operations/stop" hx-target="#global-operation-banner" hx-swap="innerHTML"
                        onclick="event.stopPropagation()">
                    <div class="di-stop__inner"></div>
                </button>
                <button class="di-dismiss" title="Minimize" onclick="event.stopPropagation(); diMinimize();">&minus;</button>
            </div>
        </div>
        {% if status.total_files is defined and status.total_files > 0 %}
        <div class="di-progress-track"><div class="di-progress-fill" style="width: {{ status.progress_percent }}%;"></div></div>
        <div class="di-progress-meta">
            <span>{{ status.completed_files }}/{{ status.total_files }} file{{ 's' if status.total_files != 1 }}
                {%- if status.last_completed_file %} &mdash; {{ status.last_completed_file|truncate(35, True, '...') }}{% endif %}</span>
            <span class="di-progress-meta__right">
                {%- if status.bytes_display %}{{ status.bytes_display }} &middot; {% endif %}
                {{- status.elapsed_display }}
                {%- if status.eta_display %} | ~{{ status.eta_display }} left{% endif %}</span>
        </div>
        {% elif status.elapsed_display is defined %}
        <div style="font-size: 0.78rem; color: rgba(255,255,255,0.5); text-align: center;">{{ status.elapsed_display }}</div>
        {% endif %}
        <!-- Tier 2 hint: click to expand detail panel -->
        <div class="di-expand-hint">
            <span>Click for details</span>
            <i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i>
        </div>
        <!-- Detail: active files + completed files + live log lines (Tier 3) -->
        <div class="di-pill__detail">
            {%- if status.active_files is defined and status.active_files %}
            <div class="di-divider"></div>
            {%- for name, size in status.active_files %}
            <div class="di-file-row di-file-row--active">
                <span class="di-action-tag di-action-tag--active">COPYING</span>
                <span class="di-file-row__name">{{ name|truncate(55, True, '...') }}</span>
            </div>
            {%- endfor %}
            {%- endif %}
            {%- if status.recent_files is defined and status.recent_files %}
            <div class="di-divider"></div>
            {%- for f in status.recent_files %}
            <div class="di-file-row">
                <span class="di-action-tag {{ 'di-action-tag--cached' if f.action == 'Cached' else 'di-action-tag--restored' }}">{{ f.action|upper }}</span>
                <span class="di-file-row__name">{{ f.filename|truncate(55, True, '...') }}</span>
                {% if f.size and f.size != '-' %}<span class="di-file-row__size">{{ f.size }}</span>{% endif %}
            </div>
            {%- endfor %}
            {%- endif %}
            <div class="di-divider"></div>
            <div id="di-log-lines">
                {%- if status.recent_logs is defined and status.recent_logs %}
                {%- for log_line in status.recent_logs %}
                <div class="di-file-row" style="font-family: monospace; font-size: 0.7rem;">
                    <span class="di-file-row__name">{{ log_line|truncate(90, True, '...') }}</span>
                </div>
                {%- endfor %}
                {%- endif %}
            </div>
            {%- if maint_status is defined and maint_status.queue_count is defined and maint_status.queue_count > 0 %}
            <div class="di-divider"></div>
            <div class="di-queue-section">
                <div class="di-queue-header">
                    <span class="di-queue-header__label">Queue ({{ maint_status.queue_count }})</span>
                    <button class="di-queue-header__clear" title="Clear queue"
                            onclick="event.stopPropagation(); fetch('/maintenance/queue/clear',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">
                        Clear
                    </button>
                </div>
                {%- for item in maint_status.queue %}
                <div class="di-queue-item">
                    <span class="di-action-tag di-action-tag--queued">QUEUED</span>
                    <span class="di-queue-item__name">{{ item.display_name }}</span>
                    {% if item.file_count %}<span class="di-queue-item__count">{{ item.file_count }} files</span>{% endif %}
                    <button class="di-queue-item__remove" title="Remove"
                            onclick="event.stopPropagation(); fetch('/maintenance/queue/remove/{{ item.id }}',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">
                        &times;
                    </button>
                </div>
                {%- endfor %}
            </div>
            {%- endif %}
        </div>
        <!-- Warning row -->
        <div id="di-warning" class="di-warning">
            <i data-lucide="alert-triangle" style="width: 14px; height: 14px; color: #e67e22; flex-shrink: 0;"></i>
            <span id="di-warning-text" style="font-size: 0.8rem; color: #e67e22; white-space: nowrap;"></span>
        </div>
    </div>

    {% if status.total_files is defined and status.total_files > 0 %}
    <div class="di-pill__progress" style="width: {{ status.progress_percent }}%;"></div>
    {% endif %}
</div>
<script>
    lucide.createIcons();
    sessionStorage.removeItem('plexcache_nextrun_dismissed');
    if (window.BannerLogStream) BannerLogStream.connect();
    {% if blocked_message is defined and blocked_message %}showBannerWarning('{{ blocked_message }}');{% endif %}
</script>

{% elif status.state == 'completed' %}
{# ═══════════════════════════════════════════════════════════
   OPERATION COMPLETED — Green pill (or orange if errors)
   ═══════════════════════════════════════════════════════════ #}
<script>
(function() {
    if (window.BannerLogStream) BannerLogStream.disconnect();
    var completionKey = 'plexcache_last_completion_shown';
    var completionId = '{{ status.completed_at or status.duration_seconds }}';
    var isRepoll = (sessionStorage.getItem(completionKey) === completionId);
    sessionStorage.setItem(completionKey, completionId);

    var filesCached = {{ status.files_cached|default(0) }};
    var filesRestored = {{ status.files_restored|default(0) }};
    var bytesCachedDisplay = '{{ status.bytes_cached_display|default("") }}';
    var bytesRestoredDisplay = '{{ status.bytes_restored_display|default("") }}';
    var durationDisplay = '{{ status.duration_display|default(status.duration_seconds ~ "s") }}';
    var errorCount = {{ status.error_count|default(0) }};
    var isDryRun = {{ 'true' if status.dry_run else 'false' }};

    // Compact summary
    var summaryParts = [];
    if (filesCached > 0) summaryParts.push(filesCached + ' cached');
    if (filesRestored > 0) summaryParts.push(filesRestored + ' restored');
    if (filesCached === 0 && filesRestored === 0) summaryParts.push('No files processed');
    var compactSummary = summaryParts.join(' · ');

    var colorMod = errorCount > 0 ? 'completed-errors' : 'completed';
    var iconName = errorCount > 0 ? 'alert-triangle' : 'check';
    var labelText = isDryRun ? 'Dry Run Complete' : 'Completed';
    var errorBadge = errorCount > 0 ? '<span class="di-error-badge">' + errorCount + ' error' + (errorCount !== 1 ? 's' : '') + '</span>' : '';

    // Expanded summary stats
    var statsHtml = '<div class="di-summary-stats">';
    if (filesCached > 0) {
        statsHtml += '<span class="di-summary-stats__cached">' + filesCached + ' cached';
        if (bytesCachedDisplay) statsHtml += ' <span class="di-summary-stats__muted">(' + bytesCachedDisplay + ')</span>';
        statsHtml += '</span>';
    }
    if (filesRestored > 0) {
        statsHtml += '<span class="di-summary-stats__restored">' + filesRestored + ' restored';
        if (bytesRestoredDisplay) statsHtml += ' <span class="di-summary-stats__muted">(' + bytesRestoredDisplay + ')</span>';
        statsHtml += '</span>';
    }
    if (filesCached === 0 && filesRestored === 0) {
        statsHtml += '<span style="color: rgba(255,255,255,0.5);">No files needed processing</span>';
    }
    statsHtml += '</div>';

    // File detail rows
    var recentFiles = [
        {% for f in status.recent_files|default([]) %}
        { action: '{{ f.action }}', filename: '{{ f.filename|truncate(45, True, "...")|e }}', size: '{{ f.size }}' },
        {% endfor %}
    ];
    var detailHtml = '';
    var hintHtml = '';
    if (recentFiles.length > 0) {
        hintHtml = '<div class="di-expand-hint"><span>Click for details</span><i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i></div>';
        detailHtml = '<div class="di-pill__detail"><div class="di-divider"></div>';
        recentFiles.forEach(function(f) {
            var tagClass = f.action === 'Cached' ? 'di-action-tag--cached' : 'di-action-tag--restored';
            detailHtml += '<div class="di-file-row">' +
                '<span class="di-action-tag ' + tagClass + '">' + f.action.toUpperCase() + '</span>' +
                '<span class="di-file-row__name">' + f.filename + '</span>' +
                (f.size !== '-' ? '<span class="di-file-row__size">' + f.size + '</span>' : '') +
                '</div>';
        });
        var totalFiles = filesCached + filesRestored;
        if (totalFiles > recentFiles.length) {
            detailHtml += '<div class="di-more-files">+ ' + (totalFiles - recentFiles.length) + ' more files</div>';
        }
        detailHtml += '</div>';
    }

    document.getElementById('global-operation-banner').innerHTML = `
        <div class="di-pill di-pill--${colorMod}" data-state="op-completed"
             hx-get="/api/operation-banner" hx-trigger="every 10s" hx-swap="innerHTML" hx-target="#global-operation-banner"
             onmouseenter="diHoverIn()" onmouseleave="diHoverOut()" onclick="diPillClick()">
            <div class="di-pill__compact">
                <div class="di-pill__left">
                    <div class="di-icon"><i data-lucide="${iconName}" style="width: 14px; height: 14px;"></i></div>
                    <span class="di-label">${labelText}</span>
                    ${errorBadge}
                </div>
                <div class="di-pill__right">
                    <span class="di-metric--muted">${compactSummary}</span>
                    <span class="di-metric" style="font-size: 0.78rem;">${durationDisplay}</span>
                </div>
            </div>
            <div class="di-pill__expanded">
                <div class="di-expanded__header">
                    <div class="di-expanded__header-left">
                        <div class="di-icon"><i data-lucide="${iconName}" style="width: 14px; height: 14px;"></i></div>
                        <span class="di-label">${isDryRun ? 'Dry Run' : 'Operation'} Completed</span>
                        ${errorBadge}
                        <span class="di-metric--muted">${durationDisplay}</span>
                    </div>
                    <div class="di-expanded__header-right">
                        <button class="di-dismiss" title="Dismiss" onclick="event.stopPropagation(); dismissCompletionBanner();">&times;</button>
                    </div>
                </div>
                ${statsHtml}
                ${hintHtml}
                ${detailHtml}
            </div>
        </div>`;
    lucide.createIcons();
    htmx.process(document.getElementById('global-operation-banner'));
    // Apply expansion class to JS-generated pill (CSS attribute selectors also apply)
    var _st = diGetExpandState(), _p = document.querySelector('#global-operation-banner .di-pill');
    if (_p) { if (_st === 'tier2') _p.classList.add('di-expanded'); if (_st === 'tier3') { _p.classList.add('di-expanded','di-detail'); } }

    // Auto-dismiss after 10s in compact; collapse back to compact restarts the timer
    var _ob = document.getElementById('global-operation-banner');
    if (_ob) {
        if (_ob._compObs) _ob._compObs.disconnect();
        if (!isRepoll) {
            clearTimeout(_ob._compTimer);
            if (diGetExpandState() === 'false') {
                _ob._compTimer = setTimeout(function() {
                    if (diGetExpandState() === 'false') dismissCompletionBanner();
                }, 10000);
            }
        }
        _ob._compObs = new MutationObserver(function() {
            clearTimeout(_ob._compTimer);
            if (diGetExpandState() === 'false') {
                _ob._compTimer = setTimeout(function() {
                    if (diGetExpandState() === 'false') dismissCompletionBanner();
                }, 10000);
            }
        });
        _ob._compObs.observe(_ob, { attributes: true, attributeFilter: ['data-di-expanded'] });
    }

    // Handle "stuck" expanded state from running→completed transition.
    // (Same fix as maintenance completion above.)
    if (diGetExpandState() !== 'false') {
        document.addEventListener('mousemove', function() {
            var p = document.querySelector('#global-operation-banner .di-pill');
            if (p && !p.matches(':hover') && diGetExpandState() !== 'false') {
                diSmoothSetState('false');
            }
        }, { once: true });
    }
})();

function dismissCompletionBanner() {
    var pill = document.querySelector('#global-operation-banner .di-pill');
    diSetExpandState('false');  /* Reset so idle pill doesn't inherit expanded layout */
    sessionStorage.removeItem('plexcache_nextrun_dismissed');
    if (pill && pill.style.opacity !== '0') {
        pill.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
        pill.style.opacity = '0';
        pill.style.transform = 'translateY(-20px)';
        setTimeout(function() {
            fetch('/api/dismiss-operation', { method: 'POST' });
            document.getElementById('global-operation-banner').innerHTML =
                '<div hx-get="/api/operation-banner" hx-trigger="every 10s" hx-swap="innerHTML" hx-target="#global-operation-banner"></div>';
            htmx.process(document.getElementById('global-operation-banner'));
        }, 400);
    }
}
</script>

{% elif status.state == 'failed' %}
{# ═══════════════════════════════════════════════════════════
   OPERATION FAILED — Red pill
   ═══════════════════════════════════════════════════════════ #}
<div class="di-pill di-pill--error" data-state="op-failed"
     onmouseenter="diHoverIn()" onmouseleave="diHoverOut()" onclick="diPillClick()">
    <div class="di-pill__compact">
        <div class="di-pill__left">
            <div class="di-icon"><i data-lucide="x-circle" style="width: 14px; height: 14px;"></i></div>
            <span class="di-label">Failed</span>
        </div>
        <div class="di-pill__right">
            {% if status.error_message %}
            <span class="di-metric--muted" style="max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ status.error_message|truncate(30, True, '...') }}</span>
            {% endif %}
            <button class="di-dismiss" title="Dismiss"
                    onclick="event.stopPropagation(); fetch('/api/dismiss-operation',{method:'POST'}); document.getElementById('global-operation-banner').innerHTML='<div hx-get=/api/operation-banner hx-trigger=every\ 10s hx-swap=innerHTML hx-target=#global-operation-banner></div>'; htmx.process(document.getElementById('global-operation-banner'));">&times;</button>
        </div>
    </div>
    <div class="di-pill__expanded">
        <div class="di-expanded__header">
            <div class="di-expanded__header-left">
                <div class="di-icon"><i data-lucide="x-circle" style="width: 14px; height: 14px;"></i></div>
                <span class="di-label">Operation Failed</span>
            </div>
            <div class="di-expanded__header-right">
                <button class="di-dismiss" title="Dismiss"
                        onclick="event.stopPropagation(); fetch('/api/dismiss-operation',{method:'POST'}); document.getElementById('global-operation-banner').innerHTML='<div hx-get=/api/operation-banner hx-trigger=every\ 10s hx-swap=innerHTML hx-target=#global-operation-banner></div>'; htmx.process(document.getElementById('global-operation-banner'));">&times;</button>
            </div>
        </div>
        {% if status.error_message %}
        <div style="font-size: 0.78rem; color: rgba(255,255,255,0.5);">{{ status.error_message }}</div>
        {% endif %}
    </div>
</div>
<script>lucide.createIcons(); if (window.BannerLogStream) BannerLogStream.disconnect();</script>

{% elif maint_status is defined and maint_status.queue_countdown is defined and maint_status.queue_countdown %}
{# ═══════════════════════════════════════════════════════════
   QUEUE COUNTDOWN — Cyan pill, 10s countdown before next queued action
   ═══════════════════════════════════════════════════════════ #}
<div class="di-pill di-pill--maintenance" data-state="queue-countdown"
     hx-get="/api/operation-banner" hx-trigger="every 2s" hx-swap="innerHTML" hx-target="#global-operation-banner"
     onmouseenter="diHoverIn()" onmouseleave="diHoverOut()" onclick="diPillClick()">
    <div class="di-pill__compact">
        <div class="di-pill__left">
            <div class="di-icon"><i data-lucide="list-ordered" style="width: 14px; height: 14px;"></i></div>
            <span class="di-label">Next: {{ maint_status.queue_next_action|truncate(22, True, '...') }}</span>
        </div>
        <div class="di-pill__right">
            <span class="di-countdown__timer" data-countdown-start="{{ maint_status.queue_countdown_started }}" data-countdown-duration="{{ maint_status.queue_countdown_seconds }}"></span>
        </div>
    </div>
    <div class="di-pill__expanded">
        <div class="di-expanded__header">
            <div class="di-expanded__header-left">
                <div class="di-icon"><i data-lucide="list-ordered" style="width: 14px; height: 14px;"></i></div>
                <span class="di-label">Next queued action</span>
            </div>
            <div class="di-expanded__header-right">
                <button class="di-dismiss" title="Minimize" onclick="event.stopPropagation(); diMinimize();">&minus;</button>
            </div>
        </div>
        <div class="di-countdown">
            <span class="di-countdown__text">{{ maint_status.queue_next_action }} starting in</span>
            <span class="di-countdown__timer" data-countdown-start="{{ maint_status.queue_countdown_started }}" data-countdown-duration="{{ maint_status.queue_countdown_seconds }}"></span>
        </div>
        <div class="di-countdown__actions">
            <button class="di-btn di-btn--primary" style="background: #5AC8FA; color: #000;"
                    onclick="event.stopPropagation(); fetch('/maintenance/queue/start-now',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">
                <i data-lucide="play" style="width: 14px; height: 14px;"></i>
                Start Now
            </button>
            <button class="di-btn di-btn--secondary"
                    onclick="event.stopPropagation(); fetch('/maintenance/queue/skip',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">
                <i data-lucide="skip-forward" style="width: 14px; height: 14px;"></i>
                Skip
            </button>
        </div>
        {% if maint_status.queue|length > 1 %}
        <div class="di-expand-hint">
            <span>Click for details</span>
            <i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i>
        </div>
        <div class="di-pill__detail">
            <div class="di-divider"></div>
            <div class="di-queue-section">
                <div class="di-queue-header">
                    <span class="di-queue-header__label">Queue ({{ maint_status.queue_count }})</span>
                    <button class="di-queue-header__clear" title="Clear queue"
                            onclick="event.stopPropagation(); fetch('/maintenance/queue/clear',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">
                        Clear
                    </button>
                </div>
                {%- for item in maint_status.queue %}
                <div class="di-queue-item">
                    <span class="di-action-tag di-action-tag--queued">QUEUED</span>
                    <span class="di-queue-item__name">{{ item.display_name }}</span>
                    {% if item.file_count %}<span class="di-queue-item__count">{{ item.file_count }} files</span>{% endif %}
                    <button class="di-queue-item__remove" title="Remove"
                            onclick="event.stopPropagation(); fetch('/maintenance/queue/remove/{{ item.id }}',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">
                        &times;
                    </button>
                </div>
                {%- endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
<script>
(function() {
    lucide.createIcons();
    // Drive countdown timers
    document.querySelectorAll('.di-countdown__timer[data-countdown-start]').forEach(function(el) {
        var started = new Date(el.dataset.countdownStart).getTime();
        var duration = parseInt(el.dataset.countdownDuration, 10) * 1000;
        function tick() {
            var remaining = Math.max(0, Math.ceil((started + duration - Date.now()) / 1000));
            el.textContent = remaining + 's';
            if (remaining > 0) requestAnimationFrame(tick);
        }
        tick();
    });
})();
</script>

{% elif maint_status is defined and maint_status.queue_paused is defined and maint_status.queue_paused and maint_status.queue_count is defined and maint_status.queue_count > 0 %}
{# ═══════════════════════════════════════════════════════════
   QUEUE PAUSED — Amber pill, queue paused after stop
   ═══════════════════════════════════════════════════════════ #}
<div class="di-pill di-pill--idle" data-state="queue-paused"
     hx-get="/api/operation-banner" hx-trigger="every 10s" hx-swap="innerHTML" hx-target="#global-operation-banner"
     onmouseenter="diHoverIn()" onmouseleave="diHoverOut()" onclick="diPillClick()">
    <div class="di-pill__compact">
        <div class="di-pill__left">
            <div class="di-icon" style="background: rgba(255,149,0,0.15); color: #FF9500;"><i data-lucide="pause" style="width: 14px; height: 14px;"></i></div>
            <span class="di-label" style="color: rgba(255,255,255,0.6);">Queue paused</span>
            <span class="di-queue-badge" style="background: rgba(255,149,0,0.2); color: #FF9500;">{{ maint_status.queue_count }}</span>
        </div>
        <div class="di-pill__right">
            <button class="di-btn di-btn--secondary" style="height: 26px; font-size: 0.72rem; padding: 0 0.6rem;"
                    onclick="event.stopPropagation(); fetch('/maintenance/queue/resume',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">
                Resume
            </button>
        </div>
    </div>
    <div class="di-pill__expanded">
        <div class="di-expanded__header">
            <div class="di-expanded__header-left">
                <div class="di-icon" style="background: rgba(255,149,0,0.15); color: #FF9500;"><i data-lucide="pause" style="width: 14px; height: 14px;"></i></div>
                <span class="di-label">Queue Paused</span>
                <span style="font-size: 0.78rem; color: rgba(255,255,255,0.4);">({{ maint_status.queue_count }} action{{ 's' if maint_status.queue_count != 1 }})</span>
            </div>
            <div class="di-expanded__header-right">
                <button class="di-btn di-btn--primary" style="background: #FF9500; color: #000; height: 28px;"
                        onclick="event.stopPropagation(); fetch('/maintenance/queue/resume',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">
                    <i data-lucide="play" style="width: 14px; height: 14px;"></i>
                    Resume
                </button>
                <button class="di-dismiss" title="Clear queue"
                        onclick="event.stopPropagation(); fetch('/maintenance/queue/clear',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">&times;</button>
            </div>
        </div>
        <div class="di-expand-hint">
            <span>Click for details</span>
            <i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i>
        </div>
        <div class="di-pill__detail">
            <div class="di-divider"></div>
            <div class="di-queue-section">
                {%- for item in maint_status.queue %}
                <div class="di-queue-item">
                    <span class="di-action-tag di-action-tag--queued">QUEUED</span>
                    <span class="di-queue-item__name">{{ item.display_name }}</span>
                    {% if item.file_count %}<span class="di-queue-item__count">{{ item.file_count }} files</span>{% endif %}
                    <button class="di-queue-item__remove" title="Remove"
                            onclick="event.stopPropagation(); fetch('/maintenance/queue/remove/{{ item.id }}',{method:'POST'}).then(()=>htmx.ajax('GET','/api/operation-banner',{target:'#global-operation-banner',swap:'innerHTML'}));">
                        &times;
                    </button>
                </div>
                {%- endfor %}
            </div>
        </div>
    </div>
</div>
<script>lucide.createIcons();</script>

{% else %}
{# ═══════════════════════════════════════════════════════════
   IDLE — Dim gold countdown pill or silent poller
   ═══════════════════════════════════════════════════════════ #}
{% if scheduler_status is defined and scheduler_status and scheduler_status.next_run_relative %}
<div class="di-pill di-pill--idle" id="idle-countdown-pill" data-state="idle"
     hx-get="/api/operation-banner" hx-trigger="every 30s" hx-swap="innerHTML" hx-target="#global-operation-banner"
     onmouseenter="diHoverIn()" onmouseleave="diHoverOut()" onclick="diPillClick()">

    <!-- Compact view -->
    <div class="di-pill__compact">
        <div class="di-pill__left">
            <i data-lucide="clock" style="width: 13px; height: 13px; color: #e5a00d; opacity: 0.6;"></i>
            <span style="font-size: 0.78rem; color: rgba(255,255,255,0.5);">Next run</span>
        </div>
        <div class="di-pill__right">
            <span class="di-metric" style="color: rgba(229,160,13,0.7); font-weight: 400; font-size: 0.8rem;">{{ scheduler_status.next_run_relative }}</span>
            <button class="di-dismiss" style="width: 22px; height: 22px; font-size: 0.8rem;" title="Dismiss"
                    onclick="event.stopPropagation(); sessionStorage.setItem('plexcache_nextrun_dismissed','1'); document.getElementById('global-operation-banner').innerHTML='<div hx-get=/api/operation-banner hx-trigger=every\\ 30s hx-swap=innerHTML hx-target=#global-operation-banner></div>'; htmx.process(document.getElementById('global-operation-banner'));">&times;</button>
        </div>
    </div>

    <!-- Expanded view — quick actions -->
    <div class="di-pill__expanded">
        <div class="di-expanded__header">
            <div class="di-expanded__header-left">
                <div class="di-icon" style="background: rgba(229,160,13,0.15); color: #e5a00d;"><i data-lucide="clock" style="width: 14px; height: 14px;"></i></div>
                <span class="di-label">Next run in {{ scheduler_status.next_run_relative }}</span>
            </div>
            <div class="di-expanded__header-right">
                <button class="di-dismiss" style="width: 22px; height: 22px; font-size: 0.8rem;" title="Dismiss"
                        onclick="event.stopPropagation(); sessionStorage.setItem('plexcache_nextrun_dismissed','1'); diSetExpandState('false'); document.getElementById('global-operation-banner').innerHTML='<div hx-get=/api/operation-banner hx-trigger=every\\ 30s hx-swap=innerHTML hx-target=#global-operation-banner></div>'; htmx.process(document.getElementById('global-operation-banner'));">&times;</button>
            </div>
        </div>
        <div class="di-idle-actions">
            <label class="di-verbose-toggle" onclick="event.stopPropagation();">
                <input type="checkbox" id="di-verbose-cb"
                       onchange="localStorage.setItem('verbose_mode', this.checked);">
                <span>Verbose</span>
            </label>
            <button class="di-btn di-btn--primary" title="Run Now"
                    onclick="event.stopPropagation(); diTriggerRun(false);">
                <i data-lucide="play" style="width: 14px; height: 14px;"></i>
                Run Now
            </button>
            <button class="di-btn di-btn--secondary" title="Dry Run"
                    onclick="event.stopPropagation(); diTriggerRun(true);">
                <i data-lucide="eye" style="width: 14px; height: 14px;"></i>
                Dry Run
            </button>
        </div>
    </div>
</div>
<script>
(function() {
    if (window.BannerLogStream) BannerLogStream.disconnect();
    // If user dismissed the countdown this session, remove the pill and fall back to silent polling
    if (sessionStorage.getItem('plexcache_nextrun_dismissed')) {
        diSetExpandState('false');
        document.getElementById('global-operation-banner').innerHTML =
            '<div hx-get="/api/operation-banner" hx-trigger="every 30s" hx-swap="innerHTML" hx-target="#global-operation-banner"></div>';
        htmx.process(document.getElementById('global-operation-banner'));
        return;
    }
    // Restore verbose preference
    var vcb = document.getElementById('di-verbose-cb');
    if (vcb && localStorage.getItem('verbose_mode') === 'true') vcb.checked = true;
    lucide.createIcons();
})();

function diTriggerRun(dryRun) {
    var verbose = document.getElementById('di-verbose-cb');
    var formData = new FormData();
    if (verbose && verbose.checked) formData.append('verbose', 'true');
    if (dryRun) formData.append('dry_run', 'true');
    // Clear dismissed state so running pill shows
    sessionStorage.removeItem('plexcache_nextrun_dismissed');
    diSetExpandState('false');
    fetch('/operations/run', { method: 'POST', body: formData })
        .then(function(resp) { return resp.text(); })
        .then(function(html) {
            document.getElementById('global-operation-banner').innerHTML = html;
            htmx.process(document.getElementById('global-operation-banner'));
            if (typeof lucide !== 'undefined') lucide.createIcons();
        });
}
</script>
{% else %}
<div hx-get="/api/operation-banner" hx-trigger="every 10s" hx-swap="innerHTML" hx-target="#global-operation-banner"></div>
{% endif %}
{% endif %}
